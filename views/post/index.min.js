var app=app||{};app.PostCreate=Backbone.Model.extend({url:function(){return"/1/post"},defaults:{success:!1,errors:[],errfor:{},subject:"",content:"",filename:""}}),app.PostCreateView=Backbone.View.extend({el:"#post",template:_.template($("#tmpl-post").html()),events:{"submit form":"preventSubmit","click button[data-toggle=save-post]":"save","click .btn-file":"initPreview"},initialize:function(){this.model=new app.PostCreate,this.listenTo(this.model,"sync",this.render),this.render(),this.initUploader()},render:function(){this.$el.html(this.template(this.model.attributes))},preventSubmit:function(a){a.preventDefault()},initPreview:function(){var a=this.$el.find(".fileinput-preview");a.removeClass("hide")},initUploader:function(){var a=this;a.$el.find("#step2").addClass("hide"),a.$el.find("#step1").removeClass("hide"),$("button[data-toggle='upload-photo']").on("click",function(){var b=($(this).data("nickname"),new FormData);b.append("file",$("#photo-upload")[0].files[0]),$.ajax({url:"/1/upload/photo",data:b,cache:!1,contentType:!1,processData:!1,type:"POST",xhr:function(){var b,c=jQuery.ajaxSettings.xhr(),d=a.$el.find(".progress"),e=a.$el.find('.progress-bar[role="progressbar"]');return d.removeClass("hide"),c.upload&&c.upload.addEventListener("progress",function(a){a.lengthComputable&&(b=Math.round(a.loaded/a.total*100),e.css("width",b+"%"),e.text(b+"%"))},!1),c},success:function(b){$(".background").css("background-image","url(/uploads/"+b.filename+")"),a.model.set("filename",b.filename),a.$el.find("#step2").removeClass("hide"),a.$el.find("#step1").addClass("hide")},complete:function(){}})})},fetchData:function(){var a=this.$el.find('[name="id"]').val(),b=this;""!==a&&$.ajax({url:"/1/post/"+a,type:"GET",dataType:"json",success:function(a){a.success===!0&&(b.model.set("post",a.post),b.$el.find('[name="content"]').val(a.post.content))},complete:function(){$.notify("正在修改一篇文章",{position:"bottom right",className:"info"})}})},save:function(){this.$el.find("button[data-toggle=save-post]").removeClass("btn-warning").addClass("disabled").text("Saving ...");var a=(this.$el.find('[name="id"]').val(),this.$el.find('[name="subject"]').val()),b=this.$el.find('[name="content"]').val();this.model.save({subject:a,content:b})}}),$(document).ready(function(){app.PostCreateView=new app.PostCreateView});